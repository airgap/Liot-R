var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(b,e,a){if(a.get||a.set)throw new TypeError("ES3 does not support getters and setters.");b!=Array.prototype&&b!=Object.prototype&&(b[e]=a.value)};$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(b){return $jscomp.SYMBOL_PREFIX+(b||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.iterator;b||(b=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[b]&&$jscomp.defineProperty(Array.prototype,b,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(b){var e=0;return $jscomp.iteratorPrototype(function(){return e<b.length?{done:!1,value:b[e++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(b){$jscomp.initSymbolIterator();b={next:b};b[$jscomp.global.Symbol.iterator]=function(){return this};return b};$jscomp.makeIterator=function(b){$jscomp.initSymbolIterator();var e=b[Symbol.iterator];return e?e.call(b):$jscomp.arrayIterator(b)};
$jscomp.checkStringArgs=function(b,e,a){if(null==b)throw new TypeError("The 'this' value for String.prototype."+a+" must not be null or undefined");if(e instanceof RegExp)throw new TypeError("First argument to String.prototype."+a+" must not be a regular expression");return b+""};
$jscomp.polyfill=function(b,e,a,c){if(e){a=$jscomp.global;b=b.split(".");for(c=0;c<b.length-1;c++){var d=b[c];d in a||(a[d]={});a=a[d]}b=b[b.length-1];c=a[b];e=e(c);e!=c&&null!=e&&$jscomp.defineProperty(a,b,{configurable:!0,writable:!0,value:e})}};$jscomp.polyfill("String.prototype.includes",function(b){return b?b:function(b,a){return-1!==$jscomp.checkStringArgs(this,b,"includes").indexOf(b,a||0)}},"es6-impl","es3");$jscomp.array=$jscomp.array||{};
$jscomp.iteratorFromArray=function(b,e){$jscomp.initSymbolIterator();b instanceof String&&(b+="");var a=0,c={next:function(){if(a<b.length){var d=a++;return{value:e(d,b[d]),done:!1}}c.next=function(){return{done:!0,value:void 0}};return c.next()}};c[Symbol.iterator]=function(){return c};return c};$jscomp.polyfill("Array.prototype.keys",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6-impl","es3");
var COMPARATORS="EQUALS NEQUALS TFEQUALS TFNEQUALS OVER OVEROR UNDER UNDEROR".split(" "),OPERATORS="AND OR NAND NOR XOR SAME".split(" "),r=require("rethinkdb"),express=require("express"),bodyParser=require("body-parser"),validUrl=require("valid-url"),app=express(),fs=require("fs"),CONFIG={port:7474};app.use(bodyParser.json());app.use(function(b,e,a){e.header("Access-Control-Allow-Origin","*");e.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept");a()});
var kRETURN_CHANGES={return_changes:!0},ADMINACTIONS={"list collectors":actionListCollectors,"add collectors":actionAddCollectors,"list filters":actionListFilters,"add filters":actionAddFilters,"list collators":actionListCollators,"add collators":actionAddCollators,"list distributors":actionListDistributors,"add distributors":actionAddDistributors,"alter distributors":actionModDistributors,"push update":actionPushUpdate},PUBLICACTIONS={};readConfig();
function readConfig(){fs.readFile("liot-server-conf.json",function(b,e){if(e){var a=JSON.parse(e.toString());a.port&&(CONFIG.port=a.port);console.log(a)}startRethinkServer();launchHttpServer()})}
function startRethinkServer(){r.connect({host:"localhost"},function(b,e){b||!e?console.log("Cannot connect to RethinkDB"):r.dbList().contains("LiotR")["do"](function(a){return r.branch(a,{dbs_created:0},r.dbCreate("LiotR"))}).run(e,function(a,b){if(a||!e)return console.log("Could not ensure existence of database for Liot R."),!1;CONNECTION=e;e.use("LiotR");b.dbs_created?console.log("Created database for Liot R."):console.log("Found database for Liot R.");console.log("Connected to database for Liot R.");
return!0})})}function launchHttpServer(){app.post("/",rcvdPost);app.listen(CONFIG.port)}function rcvdPost(b,e){var a=b.connection.remoteAddress.match(/^(127.0.0.1|::ffff:127.0.0.1|::1)$/)&&!0;console.log(a);console.log(b.body);var c=b.body.action;e.header("Access-Control-Allow-Origin","*");if(c){var d=b.body;if(a&&c in ADMINACTIONS)ADMINACTIONS[c](b,e,d);else if(c in PUBLICACTIONS)PUBLICACTIONS[c](b,e,d)}}
function actionListCollators(b,e,a){var c=0,d=100;b=["smart","name","id"];var f="smart",g=["ascending","descending"],h="ascending";"number"==typeof a.after&&(c=a.after);"number"==typeof a.count&&0<=a.count&&1001>a.count&&(d=a.count);"string"===typeof a.order&&a.order in b&&(f=b[a.order]);"string"===typeof a.direction&&a.direction in g&&(h=a.direction);"descending"==h&&(f=r.desc(f));r.table("Collators").count().run(CONNECTION,function(a,b){a||(0>c&&(c+=b),c=Math.max(0,c),r.table("Collators").orderBy(f).slice(c,
c+d).merge(function(a){return{filtrets:r.table("Filters").getAll(r.args(a("filters"))).coerceTo("array")}}).coerceTo("array").run(CONNECTION,function(a,b){a?(e.send({err:"Unable to query."}),console.log(a)):(e.send({collators:b}),console.log("Queried collators."),console.log(b))}))})}
function actionListCollectors(b,e,a){var c=0,d=100;b=["smart","name","id"];var f="smart",g=["ascending","descending"],h="ascending";"number"==typeof a.after&&(c=a.after);"number"==typeof a.count&&0<=a.count&&1001>a.count&&(d=a.count);"string"===typeof a.order&&a.order in b&&(f=b[a.order]);"string"===typeof a.direction&&a.direction in g&&(h=a.direction);"descending"==h&&(f=r.desc(f));r.table("Collectors").count().run(CONNECTION,function(a,b){a||(0>c&&(c+=b),c=Math.max(0,c),r.table("Collectors").orderBy(f).slice(c,
c+d).coerceTo("array").run(CONNECTION,function(a,b){a?(e.send({err:"Unable to query."}),console.log(a)):(e.send({collectors:b}),console.log("Queried collectors."),console.log(b))}))})}
function actionListFilters(b,e,a){var c=0,d=100;b=["smart","name","id"];var f="smart",g=["ascending","descending"],h="ascending";"number"==typeof a.after&&(c=a.after);"number"==typeof a.count&&0<=a.count&&1001>a.count&&(d=a.count);"string"===typeof a.order&&a.order in b&&(f=b[a.order]);"string"===typeof a.direction&&a.direction in g&&(h=a.direction);"descending"==h&&(f=r.desc(f));r.table("Filters").count().run(CONNECTION,function(a,b){a||(0>c&&(c+=b),c=Math.max(0,c),r.table("Filters").orderBy(f).slice(c,
c+d).coerceTo("array").run(CONNECTION,function(a,b){a?(e.send({err:"Unable to query."}),console.log(a)):(e.send({filters:b}),console.log("Queried filters."),console.log(b))}))})}
function actionListDistributors(b,e,a){var c=0,d=100;b=["smart","name","id"];var f="smart",g=["ascending","descending"],h="ascending";"number"==typeof a.after&&(c=a.after);"number"==typeof a.count&&0<=a.count&&1001>a.count&&(d=a.count);"string"===typeof a.order&&a.order in b&&(f=b[a.order]);"string"===typeof a.direction&&a.direction in g&&(h=a.direction);"descending"==h&&(f=r.desc(f));r.table("Distributors").count().run(CONNECTION,function(a,b){a||(0>c&&(c+=b),c=Math.max(0,c),r.table("Distributors").orderBy(f).slice(c,
c+d).merge(function(a){return{collets:r.table("Collators").getAll(r.args(a("collators"))).coerceTo("array")}}).coerceTo("array").run(CONNECTION,function(a,b){a?(e.send({err:"Unable to query."}),console.log(a)):(e.send({distributors:b}),console.log("Queried distributors."),console.log(b))}))})}
function actionAddCollectors(b,e,a){b=[];var c=["manufacture_date","manufacturer","model","series"];if(Array.isArray(a.collectors)){a=$jscomp.makeIterator(a.collectors);for(var d=a.next();!d.done;d=a.next())if(d=d.value,"object"===typeof d){var f={};if("object"===typeof d.device_info){var g=d.device_info;f.device_info={};for(var h=$jscomp.makeIterator(c),l=h.next();!l.done;l=h.next())l=l.value,"string"===typeof g[l]&&100>g[l].length&&(f.device_info[l]=g[l])}"string"===typeof d.name&&100>d.name.length&&
(f.name=d.name);f.value=0;f.smart=sortify(d.name||"");f.aggregate=!!d.aggregate;f.accessor=r.uuid();b.push(f)}r.table("Collectors").insert(b).run(CONNECTION,function(a,b){e.send(a?{err:"Could not create collectors."}:{})})}}function sortify(b){var e=0;if(b=b.match(/([A-Za-z]+|[0-9]+|.+?)/g))for(var a=0;a<b.length;a++){var c=b[a];if(c.match(/^[A-Za-z]+$/))for(var d in c)e+=c.charCodeAt(d);else if(c.match(/^[0-9]+$/))e+=1*c;else for(d in c)e+=c.charCodeAt(d)}return e}
function actionAddCollators(b,e,a){if(Array.isArray(a.collators)){var c=[];b=$jscomp.makeIterator(a.collators);for(a=b.next();!a.done;a=b.next()){var d=a.value;a={};"string"===typeof d.name&&d.name.length&&(a.name=d.name);if(Array.isArray(d.filters))for(var f=[],d=$jscomp.makeIterator(d.filters),g=d.next();!g.done;g=d.next())g=g.value,"string"===typeof g&&-1==f.indexOf(g)&&f.push(g);a.filters=f;c.push(a)}}r.table("Collators").insert(c).run(CONNECTION,function(a,b){a?(e.send({err:"Unable to create collators."}),
console.log(a)):(e.send({}),console.log("Created collators."))})}
function actionAddDistributors(b,e,a){if(Array.isArray(a.distributors)){b=[];a=$jscomp.makeIterator(a.distributors);for(var c=a.next();!c.done;c=a.next()){var c=c.value,d={collators:[]};if(Array.isArray(c.collators))for(var f=$jscomp.makeIterator(c.collators),g=f.next();!g.done;g=f.next())d.collators.push(g.value);"string"===typeof c.url&&validUrl.isUri(c.url)&&(d.url=c.url);"string"===typeof c.name&&0<c.name.length&&(d.name=c.name);d.push=!!c.push;d.queue=!!c.queue;d.callback=!!c.callback;b.push(d)}r.table("Distributors").insert(b).run(CONNECTION,
function(a,b){a?(e.send({err:"Error creating distributors."}),console.log(a)):(e.send({}),console.log("Created distributors."))})}}
function actionAddFilters(b,e,a){function c(a){e.send({err:a});console.log(a)}if(Array.isArray(a.filters)){b=[];a=$jscomp.makeIterator(a.filters);for(var d=a.next();!d.done;d=a.next()){var d=d.value,f={};"string"===typeof d.name&&(f.name=d.name);if("string"===typeof d.code){var g=function(a,b){var e="undefined"==typeof b;if(e||"number"!==typeof a[b]&&"string"!==typeof a[b])if(Array.isArray(a))Array.isArray(a)&&(console.log("array: "+b),COMPARATORS.includes(b)?2!=a.length&&c("All comparators expect 2 parameters. Found "+
a.length):c("Invalid comparator."));else if(e||!b||OPERATORS.includes(b)){var d=Object.keys(a);console.log(e&&1!=d.length);if(e&&1!=d.length)c("Root object must contain exactly one object, not "+d.length);else if(e||2===d.length)for(e=$jscomp.makeIterator(d),d=e.next();!d.done;d=e.next())if(d=d.value,COMPARATORS.includes(d))g(a[d],d);else if(OPERATORS.includes(d))g(a[d],d);else{c("Invalid comparator or operator.");break}else c("Operator "+b+" expects 2 parameters, not "+d.length)}else c("Not a valid operator.");
else COMPARATORS.includes(b)||c("All numbers and strings must reside in comparators.")},h=d.code,l;try{l=JSON.parse(h)}catch(m){c("Invalid JSON.");return}console.log(l);g(l);f.code=d.code;f.json=l}b.push(f)}r.table("Filters").insert(b).run(CONNECTION,function(a,b){a?(e.send({err:"Error creating filters."}),console.log(a)):(e.send({}),console.log("Created filters."))})}}
function actionModDistributors(b,e,a){if(Array.isArray(a.distributors)){b=[];a=$jscomp.makeIterator(a.distributors);for(var c=a.next();!c.done;c=a.next()){var d=c.value,c={sources:[]};if(Array.isArray(d.sources))for(var d=$jscomp.makeIterator(d.sources),f=d.next();!f.done;f=d.next())c.sources.push(f.value);b.push(c)}r.table("Distributors").update(b).run(CONNECTION,function(a,b){a?(e.send({err:"Error updating distributors."}),console.log(a)):(e.send({}),console.log("Updated distributors."))})}}
function actionPushUpdate(b,e,a){function c(a,b){console.log(a||b);if(b&&"object"==typeof b.changes[0].new_val){var c=b.changes[0].new_val;r.table("Distributors").without("name").merge(function(a){return{collators:r.table("Collators").getAll(r.args(a("collators"))).pluck("id","filters").merge(function(a){return{filters:r.table("Filters").getAll(r.args(a("filters"))).pluck("id","json","code").coerceTo("array")}}).coerceTo("array")}}).coerceTo("array").run(CONNECTION,function(a,b){for(var d={},e=$jscomp.makeIterator(b),
f=e.next();!f.done;f=e.next())for(var f=$jscomp.makeIterator(f.value.collators),g=f.next();!g.done;g=f.next())for(var g=$jscomp.makeIterator(g.value.filters),h=g.next();!h.done;h=g.next())h=h.value,d.hasOwnProperty(h.id)||(d[h.id]=h.json);console.log(d);e=!1;f=Object.keys(d);f=$jscomp.makeIterator(f);for(g=f.next();!g.done;g=f.next())if(k=g.value,recur(d[k],c,"ROOT")){e=!0;break}e?console.log("PASS"):console.log("FAIL")})}}var d;"string"!=typeof a.accessor?e.send({err:"No accessor specified."}):(b=
typeof a.value,"undefined"==b||"null"==b?e.send({err:"No value specified."}):"string"==typeof a.id?d=a.id:(e=a.accessor,a=a.value,d?r.branch(r.table("Collectors").getAll(e,{index:"accessor"}).filter({aggregate:!0}).limit(1).count().eq(1),r.table("Collectors").get(d).update({value:a},{return_changes:"always"}),{replaced:0}).run(CONNECTION,c):r.table("Collectors").getAll(e,{index:"accessor"}).update({value:a},{return_changes:"always"}).run(CONNECTION,c)))}
function recur(b,e,a){var c,d=!1;c=evaluateProperty(b,e,0);e=evaluateProperty(b,e,1);switch(a){case "ROOT":d=!!c;break;case "AND":d=c&&e;break;case "OR":d=c||e;break;case "NAND":d=!(c&&e);break;case "NOR":d=!(c||e);break;case "XOR":d=(c||e)&&!(c&&e);break;case "UNDER":d=c<e;break;case "OVER":d=c>e;break;case "EQUALS":d=c==e;break;case "TFEQUALS":d=c===e;break;case "NEQUALS":d=c!=e;break;case "TFNEQUALS":d=c!==e;break;case "OVEROR":d=c>=e;break;case "UNDEROR":d=c<=e}console.log(b,c,e,a,d);return d}
function getProperty(b,e){for(var a=$jscomp.makeIterator(e.substring(1).split(".")),c=a.next();!c.done;c=a.next())if(c=c.value,console.log(c,b[c]),"undefined"!=typeof b[c]&&"null"!=typeof b[c])b=b[c];else return null;console.log("PROP",b);return b}function evaluateProperty(b,e,a){a=Object.keys(b)[a];b=b[a];switch(typeof b){case "object":b=recur(b,e,a);break;case "string":"$"===b[0]&&(b=getProperty(e,b))}return b};
