var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,d){if(d.get||d.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=d.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.makeIterator=function(a){$jscomp.initSymbolIterator();var b=a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};$jscomp.array=$jscomp.array||{};
$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var d=0,c={next:function(){if(d<a.length){var e=d++;return{value:b(e,a[e]),done:!1}}c.next=function(){return{done:!0,value:void 0}};return c.next()}};c[Symbol.iterator]=function(){return c};return c};
$jscomp.polyfill=function(a,b,d,c){if(b){d=$jscomp.global;a=a.split(".");for(c=0;c<a.length-1;c++){var e=a[c];e in d||(d[e]={});d=d[e]}a=a[a.length-1];c=d[a];b=b(c);b!=c&&null!=b&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6-impl","es3");
var DEBUG=1,COMPARATORS="EQUALS NEQUALS TFEQUALS TFNEQUALS OVER OVEROR UNDER UNDEROR".split(" "),OPERATORS="AND OR NAND NOR XOR SAME".split(" "),r=require("rethinkdb"),express=require("express"),bodyParser=require("body-parser"),validUrl=require("valid-url"),request=require("request"),app=express(),fs=require("fs"),CONFIG={port:7474};app.use(bodyParser.json());
app.use(function(a,b,d){b.header("Access-Control-Allow-Origin","*");b.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept");d()});var kRETURN_CHANGES={return_changes:!0},actions={collectors:{}};actions.collectors.list=require("./modules/action-list-collectors");actions.collectors.add=require("./modules/action-add-collectors");actions.collectors.get=require("./modules/action-get-collectors");actions.collectors["delete"]=require("./modules/action-delete-collectors");
actions.filters={};actions.filters.list=require("./modules/action-list-filters");actions.filters.add=require("./modules/action-add-filters");actions.filters.get=require("./modules/action-get-filters");actions.filters["delete"]=require("./modules/action-delete-filters");actions.filters.references={};actions.filters.references.count=require("./modules/action-count-filter-references");actions.filters.referrers.count=require("./modules/action-list-filter-referrers");actions.collators={};
actions.collators.list=require("./modules/action-list-collators");actions.collators.add=require("./modules/action-add-collators");actions.collators.get=require("./modules/action-get-collators");actions.collators["delete"]=require("./modules/action-delete-collators");actions.collators.references.count=require("./modules/action-count-collator-references");actions.distributors={};actions.distributors.list=require("./modules/action-list-distributors");actions.distributors.add=require("./modules/action-add-distributors");
actions.distributors.get=require("./modules/action-get-distributors");actions.distributors["delete"]=require("./modules/action-delete-distributors");actions.updates={};actions.updates.push=require("./modules/action-push-update");
var ADMINACTIONS={"list collectors":actions.collectors.list,"add collectors":actions.collectors.add,"get collectors":actions.getCollectors,"delete collectors":actions.deleteCollectors,"list filters":actions.filters.list,"add filters":actions.filters.add,"get filters":actions.filters.get,"delete filters":actions.filters["delete"],"count filter references":actions.filters.references.count,"list filter referrers":actions.filters.referrers.list,"list collators":actions.collators.list,"add collators":actions.collators.add,
"get collators":actions.collators.get,"delete collators":actions.collators["delete"],"count collator references":actions.collators.references.count,"list distributors":actions.distributors.list,"add distributors":actions.distributors.add,"get distributors":actions.distributors.get,"delete distributors":actions.distributors["delete"],"push update":actions.updates.push},PUBLICACTIONS={};readConfig();
function readConfig(){fs.readFile("liot-server-conf.json",function(a,b){if(b){var d=JSON.parse(b.toString());d.port&&(CONFIG.port=d.port);DEBUG&&console.log(d)}startRethinkServer();launchHttpServer()})}
function startRethinkServer(){r.connect({host:"localhost"},function(a,b){a||!b?DEBUG&&console.log("Cannot connect to RethinkDB"):r.dbList().contains("LiotR")["do"](function(a){return r.branch(a,{dbs_created:0},r.dbCreate("LiotR"))}).run(b,function(a,c){if(a||!b)return DEBUG&&console.log("Could not ensure existence of database for Liot R."),!1;CONNECTION=b;b.use("LiotR");c.dbs_created&&(DEBUG?console.log("Created database for Liot R."):DEBUG&&console.log("Found database for Liot R."));DEBUG&&console.log("Connected to database for Liot R.");
return!0})})}function launchHttpServer(){app.post("/",rcvdPost);app.listen(CONFIG.port)}function rcvdPost(a,b){var d=a.connection.remoteAddress.match(/^(127.0.0.1|::ffff:127.0.0.1|::1)$/)&&!0;DEBUG&&console.log(d);DEBUG&&console.log(a.body);var c=a.body.action;b.header("Access-Control-Allow-Origin","*");if(c){var e=a.body;if(d&&c in ADMINACTIONS)ADMINACTIONS[c](CONNECTION,a,b,e);else if(c in PUBLICACTIONS)PUBLICACTIONS[c](CONNECTION,a,b,e)}}
function sortify(a){var b=0;if(a=a.match(/([A-Za-z]+|[0-9]+|.+?)/g))for(var d=0;d<a.length;d++){var c=a[d];if(c.match(/^[A-Za-z]+$/))for(var e in c)b+=c.charCodeAt(e);else if(c.match(/^[0-9]+$/))b+=1*c;else for(e in c)b+=c.charCodeAt(e)}return b}function sendDataToCallback(a,b){b.match(/^[A-Za-z]+:\/\//)||(b="http://"+b);request.post({headers:{"content-type":"application/json"},url:b,body:a,json:!0},function(a,c,b){DEBUG&&console.log("Called back")})}
function recur(a,b,d){var c,e=!1;c=evaluateProperty(a,b,0);b=evaluateProperty(a,b,1);switch(d){case "ROOT":e=!!c;break;case "AND":e=c&&b;break;case "OR":e=c||b;break;case "NAND":e=!(c&&b);break;case "NOR":e=!(c||b);break;case "XOR":e=(c||b)&&!(c&&b);break;case "UNDER":e=c<b;break;case "OVER":e=c>b;break;case "EQUALS":e=c==b;break;case "TFEQUALS":e=c===b;break;case "NEQUALS":e=c!=b;break;case "TFNEQUALS":e=c!==b;break;case "OVEROR":e=c>=b;break;case "UNDEROR":e=c<=b}DEBUG&&console.log(a,c,b,d,e);return e}
function getProperty(a,b){for(var d=$jscomp.makeIterator(b.substring(1).split(".")),c=d.next();!c.done;c=d.next())if(c=c.value,DEBUG&&console.log(c,a[c]),"undefined"!=typeof a[c]&&"null"!=typeof a[c])a=a[c];else return null;DEBUG&&console.log("PROP",a);return a}function evaluateProperty(a,b,d){d=Object.keys(a)[d];a=a[d];switch(typeof a){case "object":a=recur(a,b,d);break;case "string":"$"===a[0]&&(a=getProperty(b,a))}return a}
function buildFilterReferenceCounterQuery(a,b){var d=r.table("Filters");Array.isArray(a)&&(d=d.filter(function(c){return r.expr(a).contains(c("id"))}));return d=d.map(function(a){return{id:a("id"),refcount:r.table("Collators").group("id")("filters")(0).contains(a("id")).ungroup()("reduction").filter(function(a){return a.eq(!0)}).count()}})}
function buildCollatorReferenceCounterQuery(a,b){var d=r.table("Collators");Array.isArray(a)&&(d=d.filter(function(c){return r.expr(a).contains(c("id"))}));return d=d.map(function(a){return{id:a("id"),refcount:r.table("Distributors").group("id")("collators")(0).contains(a("id")).ungroup()("reduction").filter(function(a){return a.eq(!0)}).count()}})}
function buildFilterReferrerListerQuery(a,b){var d=r.table("Filters");Array.isArray(a)&&(d=d.filter(function(c){return r.expr(a).contains(c("id"))}));return d=d.map(function(a){return{id:a("id"),referrers:r.db("LiotR").table("Collators").filter(function(b){return b("filters").contains(a("id"))}).merge(function(a){return{filtrets:r.table("Filters").getAll(r.args(a("filters"))).coerceTo("array")}}).coerceTo("array")}})}
function buildFilterDistributorListerQuery(a,b){var d=r.table("Filters");Array.isArray(a)&&(d=d.filter(function(b){return r.expr(a).contains(b("id"))}));return d=d.map(function(a){return{id:a("id"),referrers:r.db("LiotR").table("Collators").filter(function(b){return b("filters").contains(a("id"))}).merge(function(a){return{filtrets:r.table("Filters").getAll(r.args(a("filters"))).coerceTo("array")}}).coerceTo("array")}})};
