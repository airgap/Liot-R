var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,e){if(e.get||e.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=e.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.makeIterator=function(a){$jscomp.initSymbolIterator();var b=a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};$jscomp.array=$jscomp.array||{};
$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var e=0,c={next:function(){if(e<a.length){var d=e++;return{value:b(d,a[d]),done:!1}}c.next=function(){return{done:!0,value:void 0}};return c.next()}};c[Symbol.iterator]=function(){return c};return c};
$jscomp.polyfill=function(a,b,e,c){if(b){e=$jscomp.global;a=a.split(".");for(c=0;c<a.length-1;c++){var d=a[c];d in e||(e[d]={});e=e[d]}a=a[a.length-1];c=e[a];b=b(c);b!=c&&null!=b&&$jscomp.defineProperty(e,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6-impl","es3");var r=require("rethinkdb");
module.exports=function(a,b,e,c,d){function p(d,e){a&&console.log(d||e);if(e&&"object"==typeof e.changes[0].new_val){var p=e.changes[0].new_val;r.table("Distributors").without("name").merge(function(a){return{collators:r.table("Collators").getAll(r.args(a("collators"))).pluck("id","filters").merge(function(a){return{filters:r.table("Filters").getAll(r.args(a("filters"))).pluck("id","json","code").coerceTo("array")}}).coerceTo("array")}}).coerceTo("array").run(b,function(e,d){for(var m={},t=[],l=$jscomp.makeIterator(d),
g=l.next();!g.done;g=l.next())for(var g=g.value,g=$jscomp.makeIterator(g.collators),f=g.next();!f.done;f=g.next())for(var f=f.value,n=$jscomp.makeIterator(f.filters),f=n.next();!f.done;f=n.next())f=f.value,m.hasOwnProperty(f.id)||(m[f.id]=f.json);a&&console.log(m);for(var q=!1,g=Object.keys(m),g=$jscomp.makeIterator(g),l=g.next();!l.done;l=g.next())k=l.value,recur(m[k],p,"ROOT")&&(m[k]=!0);l=$jscomp.makeIterator(d);for(g=l.next();!g.done;g=l.next())for(g=g.value,n=$jscomp.makeIterator(g.collators),
f=n.next();!f.done;f=n.next()){for(var f=f.value,q=!1,u=$jscomp.makeIterator(f.filters),f=u.next();!f.done;f=u.next())if(f=f.value,m[f.id]){f=JSON.parse(JSON.stringify(h));g.accessor&&(f.accessor=g.accessor);g.push&&!g.queue&&(f.id=r.uuid(f.id+" "+g.id));f.distributor=g.id;t.push(f);g.callback&&validUrl.isUri(g.url)?sendDataToCallback(f,g.url):g.push&&r.table("DistributedData").insert(t).run(b,function(b,c){a&&console.log(b||c)});q=!0;break}if(q)break}a&&console.log("PASS");c.send({})})}}var h={};
"string"!=typeof d.accessor?c.send({err:"No accessor specified."}):(e=typeof d.value,"undefined"==e||"null"==e?c.send({err:"No value specified."}):"string"==typeof d.id?h.id=d.id:(h.accessor=d.accessor,h.value=d.value,h.id?r.branch(r.table("Collectors").getAll(h.accessor,{index:"accessor"}).filter({aggregate:!0}).limit(1).count().eq(1),r.table("Collectors").get(h.id).update({value:h.value},{return_changes:"always"}),{replaced:0}).run(b,p):r.table("Collectors").getAll(h.accessor,{index:"accessor"}).update({value:h.value},
{return_changes:"always"}).run(b,p)))};function sendDataToCallback(a,b){b.match(/^[A-Za-z]+:\/\//)||(b="http://"+b);request.post({headers:{"content-type":"application/json"},url:b,body:a,json:!0},function(a,b,d){DEBUG&&console.log("Called back")})}
function recur(a,b,e){var c,d=!1;c=evaluateProperty(a,b,0);b=evaluateProperty(a,b,1);switch(e){case "ROOT":d=!!c;break;case "AND":d=c&&b;break;case "OR":d=c||b;break;case "NAND":d=!(c&&b);break;case "NOR":d=!(c||b);break;case "XOR":d=(c||b)&&!(c&&b);break;case "UNDER":d=c<b;break;case "OVER":d=c>b;break;case "EQUALS":d=c==b;break;case "TFEQUALS":d=c===b;break;case "NEQUALS":d=c!=b;break;case "TFNEQUALS":d=c!==b;break;case "OVEROR":d=c>=b;break;case "UNDEROR":d=c<=b}DEBUG&&console.log(a,c,b,e,d);return d}
function getProperty(a,b){for(var e=$jscomp.makeIterator(b.substring(1).split(".")),c=e.next();!c.done;c=e.next())if(c=c.value,DEBUG&&console.log(c,a[c]),"undefined"!=typeof a[c]&&"null"!=typeof a[c])a=a[c];else return null;DEBUG&&console.log("PROP",a);return a}function evaluateProperty(a,b,e){e=Object.keys(a)[e];a=a[e];switch(typeof a){case "object":a=recur(a,b,e);break;case "string":"$"===a[0]&&(a=getProperty(b,a))}return a};
